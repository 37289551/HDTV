name: Channel List Sync

on:
  schedule:
    - cron: '0 */2 * * *'
  workflow_dispatch:

jobs:
  sync-channels:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Fetch channel list from remote source
      run: |
        curl -s -o /tmp/remote_channels.m3u https://raw.githubusercontent.com/develop202/migu_video/refs/heads/main/interface.txt
        
    - name: Convert m3u to txt format
      run: |
        grep -E '^#EXTINF:-1' /tmp/remote_channels.m3u | \
        sed -E 's/^#EXTINF:-1[^,]*,(.*)/\1/' > /tmp/remote_channels.txt
        
        echo "提取到的远程频道数量: $(wc -l < /tmp/remote_channels.txt)"
        
    - name: Process channel names with mapping
      run: |
        sed -E '
          s/CCTV1综合/CCTV-1/g;
          s/CCTV2财经/CCTV-2/g;
          s/CCTV3综艺/CCTV-3/g;
          s/CCTV4中文国际/CCTV-4/g;
          s/CCTV5体育/CCTV-5/g;
          s/CCTV5\+体育赛事/CCTV-5+/g;
          s/CCTV6电影/CCTV-6/g;
          s/CCTV7国防军事/CCTV-7/g;
          s/CCTV8电视剧/CCTV-8/g;
          s/CCTV9纪录/CCTV-9/g;
          s/CCTV10科教/CCTV-10/g;
          s/CCTV11戏曲/CCTV-11/g;
          s/CCTV12社会与法/CCTV-12/g;
          s/CCTV13新闻/CCTV-13/g;
          s/CCTV14少儿/CCTV-14/g;
          s/CCTV15音乐/CCTV-15/g;
          s/CCTV16奥林匹克/CCTV-16/g;
          s/CCTV17农业农村/CCTV-17/g
        ' /tmp/remote_channels.txt > /tmp/mapped_channels.txt
        
    - name: Precise channel insertion
      run: |
        mkdir -p output
        
        if [ ! -f output/userresult.txt ]; then
          echo "目标文件不存在，创建空文件"
          touch output/userresult.txt
        fi
        
        # 创建临时工作文件
        cp output/userresult.txt /tmp/final_result.txt
        
        # 读取映射后的远程频道列表
        while IFS= read -r remote_channel; do
          # 检查目标文件中是否包含该频道
          if grep -q "^$remote_channel$" output/userresult.txt; then
            echo "找到相同频道: $remote_channel，执行精确插入"
            
            # 找到第一个匹配的频道位置，并在其前面插入
            awk -v channel="$remote_channel" '
              $0 == channel && !found {
                print channel
                found = 1
              }
              {print}
            ' /tmp/final_result.txt > /tmp/updated_result.txt
            
            mv /tmp/updated_result.txt /tmp/final_result.txt
          else
            echo "跳过目标文件中不存在的频道: $remote_channel"
          fi
        done < /tmp/mapped_channels.txt
        
        # 检查是否有变更
        if ! cmp -s output/userresult.txt /tmp/final_result.txt; then
          echo "检测到频道结构更新"
          cp /tmp/final_result.txt output/userresult.txt
        else
          echo "频道结构无变化"
        fi
        
    - name: Commit and push if changes
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        if git diff --quiet; then
          echo "没有检测到文件变更"
        else
          git add output/userresult.txt
          git commit -m "精确更新电视频道结构 [skip ci]"
          git push
        fi
