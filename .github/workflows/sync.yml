name: sync to gitee
on:
#  schedule:
 #   - cron: '0 0-22/2 * * *'
  workflow_dispatch:

jobs:
  sync-job:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout GitHub Repo
        uses: actions/checkout@v4
        with:
          ref: master

      - name: Filter channels and create new file
        run: |
         for file in output/*; do
            if [ -f "$file" ] && grep -q "环球频道,#genre#" "$file"; then
               echo "Processing file: $file"
            awk '
            /环球频道,#genre#/ { 
              print
              skip_section = 1
              next
            }
            skip_section && /^[[:space:]]*$/ { 
              skip_section = 0
              print
              next
            }
            skip_section && /^[^#]/ && /,#genre#/ {
              next
            }
            { print }
            ' "$file" > "output/abc.txt"
            echo "Filtered file created: output/abc.txt"
            break
          fi
         done
        
      - name: Commit and push if changes
        run: |
         git config --local user.email "action@github.com"
         git config --local user.name "GitHub Action"
         git add output/abc.txt
         git diff --staged --quiet || git commit -m "Add filtered channels file"
         git push
       
      - name: Download files
        run: |
          curl -o IPV4.txt "https://raw.githubusercontent.com/${{ github.repository }}/master/output/userresult.txt"
          # curl -o IPV6.txt "https://raw.githubusercontent.com/${{ github.repository }}/master/output/ipv6/result.txt"
          # curl -o IPV4.m3u "https://raw.githubusercontent.com/${{ github.repository }}/master/output/userresult.m3u"

      - name: Clone Gitee Repo
        env:
          GITEE_USER: ${{ secrets.GITEE_USER }}
          GITEE_TOKEN: ${{ secrets.GITEE_TOKEN }}
          GITEE_REPO: ${{ secrets.GITEE_REPO }}
        run: |
          git clone "https://${GITEE_USER}:${GITEE_TOKEN}@gitee.com/${GITEE_USER}/${GITEE_REPO}.git" gitee-repo

      - name: Sync files
        run: |
          cd gitee-repo
          git config user.name "GitHub Actions"
          git config user.email "actions@users.noreply.github.com"
          git checkout master || git checkout -b master
          cp ../IPV4.txt ./
          # cp ../IPV6.txt ./
          # cp ../IPV4.m3u ./
          git add IPV4.txt 
          # add to above line IPV6.txt IPV4.m3u
          git commit -m "Sync from GitHub" || exit 0
          git push origin master
