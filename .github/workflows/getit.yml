name: Channel Processor

on:
  schedule:
    - cron: '0 */2 * * *'  # æ¯ä¸¤å°æ—¶æ‰§è¡Œä¸€æ¬¡
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  process-channels:
    runs-on: ubuntu-latest
    name: ğŸ¬ Process Channel Lists
    
    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4
      with:
        ref: master
        fetch-depth: 0

    - name: ğŸ Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.10"

    - name: ğŸ“¦ Install dependencies
      run: pip install requests

    - name: â¬‡ï¸ Download and process m3u file
      run: |
        echo "å¼€å§‹ä¸‹è½½å’Œå¤„ç†M3Uæ–‡ä»¶..."
        mkdir -p output
        python << 'EOF'
        import requests
        import re
        
        # ä¸‹è½½è¿œç¨‹m3uæ–‡ä»¶
        url = "https://raw.githubusercontent.com/develop202/migu_video/refs/heads/main/interface.txt"
        print(f"æ­£åœ¨ä» {url} ä¸‹è½½æ–‡ä»¶...")
        response = requests.get(url)
        m3u_content = response.text
        
        # è§£æm3uæ ¼å¼å¹¶è½¬æ¢ä¸ºtxtæ ‡å‡†æ ¼å¼
        lines = m3u_content.split('\n')
        output_lines = []
        
        # CCTVé¢‘é“åç§°æ ‡å‡†åŒ–æ˜ å°„
        channel_mapping = {
            "CCTV1ç»¼åˆ": "CCTV-1",
            "CCTV2è´¢ç»": "CCTV-2", 
            "CCTV3ç»¼è‰º": "CCTV-3",
            "CCTV4ä¸­æ–‡å›½é™…": "CCTV-4",
            "CCTV5ä½“è‚²": "CCTV-5",
            "CCTV5+ä½“è‚²èµ›äº‹": "CCTV-5+",
            "CCTV6ç”µå½±": "CCTV-6",
            "CCTV7å›½é˜²å†›äº‹": "CCTV-7",
            "CCTV8ç”µè§†å‰§": "CCTV-8",
            "CCTV9çºªå½•": "CCTV-9",
            "CCTV10ç§‘æ•™": "CCTV-10",
            "CCTV11æˆæ›²": "CCTV-11",
            "CCTV12ç¤¾ä¼šä¸æ³•": "CCTV-12",
            "CCTV13æ–°é—»": "CCTV-13",
            "CCTV14å°‘å„¿": "CCTV-14",
            "CCTV15éŸ³ä¹": "CCTV-15",
            "CCTV16å¥¥æ—åŒ¹å…‹": "CCTV-16",
            "CCTV17å†œä¸šå†œæ‘": "CCTV-17"
        }
        
        current_channel = None
        for line in lines:
            line = line.strip()
            if line.startswith('#EXTINF:'):
                # æå–é¢‘é“åç§°
                match = re.search(r',(.+)$', line)
                if match:
                    current_channel = match.group(1)
                    # åº”ç”¨é¢‘é“æ˜ å°„
                    for old_name, new_name in channel_mapping.items():
                        if old_name in current_channel:
                            current_channel = current_channel.replace(old_name, new_name)
            elif line.startswith('http'):
                if current_channel:
                    output_lines.append(f"{current_channel}, {line}")
                    current_channel = None
        
        # å†™å…¥å¤„ç†åçš„å†…å®¹
        with open('output/remote.txt', 'w', encoding='utf-8') as f:
            f.write('\n'.join(output_lines))
        
        print(f"âœ… æˆåŠŸå¤„ç† {len(output_lines)} ä¸ªé¢‘é“")
        print("å¤„ç†çš„é¢‘é“ç¤ºä¾‹:")
        for i, channel in enumerate(output_lines[:5]):
            print(f"  {i+1}. {channel.split(',')[0]}")
        EOF

    - name: ğŸ”„ Merge channels to user result
      run: |
        python << 'EOF'
        import os
        
        def read_channels(filename):
            """è¯»å–é¢‘é“æ–‡ä»¶ï¼Œè¿”å›é¢‘é“å­—å…¸"""
            if not os.path.exists(filename):
                print(f"âš ï¸ æ–‡ä»¶ {filename} ä¸å­˜åœ¨")
                return {}
            
            channels = {}
            with open(filename, 'r', encoding='utf-8') as f:
                for line_num, line in enumerate(f, 1):
                    line = line.strip()
                    if line and ',' in line:
                        try:
                            name, url = line.split(',', 1)
                            channels[name.strip()] = url.strip()
                        except Exception as e:
                            print(f"âš ï¸ ç¬¬ {line_num} è¡Œè§£æå¤±è´¥: {e}")
            return channels
        
        def write_channels(filename, channels_dict):
            """å°†é¢‘é“å­—å…¸å†™å…¥æ–‡ä»¶"""
            with open(filename, 'w', encoding='utf-8') as f:
                for name, url in channels_dict.items():
                    f.write(f"{name}, {url}\n")
        
        print("å¼€å§‹åˆå¹¶é¢‘é“åˆ—è¡¨...")
        
        # è¯»å–remote.txtå’Œuserresult.txt
        remote_channels = read_channels('output/remote.txt')
        user_channels = read_channels('output/userresult.txt')
        
        print(f"ğŸ“Š ç»Ÿè®¡ä¿¡æ¯:")
        print(f"  - è¿œç¨‹é¢‘é“æ•°: {len(remote_channels)}")
        print(f"  - ç”¨æˆ·åŸæœ‰é¢‘é“æ•°: {len(user_channels)}")
        
        # ä¿®å¤ï¼šä¿ç•™æ‰€æœ‰åŸæœ‰é¢‘é“ï¼Œåªæ›´æ–°åŒ¹é…çš„é¢‘é“
        merged_channels = user_channels.copy()  # ä¿ç•™æ‰€æœ‰åŸæœ‰é¢‘é“
        
        update_count = 0
        add_count = 0
        
        for remote_name, remote_url in remote_channels.items():
            if remote_name in merged_channels:
                # æ£€æŸ¥æ˜¯å¦éœ€è¦æ›´æ–°
                existing_url = merged_channels[remote_name]
                if existing_url.startswith('http://gslbmgsplive.miguvideo.com'):
                    merged_channels[remote_name] = remote_url
                    update_count += 1
                    print(f"ğŸ”„ æ›´æ–°é¢‘é“: {remote_name}")
                else:
                    # ä¿æŒåŸæœ‰é¢‘é“ä¸å˜
                    print(f"ğŸ“ ä¿ç•™åŸæœ‰é¢‘é“: {remote_name}")
            else:
                # å¦‚æœç”¨æˆ·æ–‡ä»¶ä¸­æ²¡æœ‰è¯¥é¢‘é“ï¼Œå¯ä»¥é€‰æ‹©æ·»åŠ ï¼ˆè¿™é‡Œé€‰æ‹©ä¸æ·»åŠ ä»¥ä¿æŒåŸæœ‰ç»“æ„ï¼‰
                # å¦‚éœ€è¦æ·»åŠ ï¼Œå–æ¶ˆä¸‹é¢æ³¨é‡Šï¼š
                # merged_channels[remote_name] = remote_url
                # add_count += 1
                # print(f"â• æ·»åŠ æ–°é¢‘é“: {remote_name}")
                pass
        
        # å†™å…¥åˆå¹¶åçš„ç»“æœ
        write_channels('output/userresult.txt', merged_channels)
        
        print(f"ğŸ‰ åˆå¹¶å®Œæˆ!")
        print(f"ğŸ“ˆ æœ€ç»ˆç»Ÿè®¡:")
        print(f"  - æ€»é¢‘é“æ•°: {len(merged_channels)}")
        print(f"  - æ›´æ–°é¢‘é“æ•°: {update_count}")
        print(f"  - æ·»åŠ é¢‘é“æ•°: {add_count}")
        print(f"  - ä¿ç•™åŸæœ‰é¢‘é“æ•°: {len(merged_channels) - add_count}")
        EOF

    - name: ğŸ’¾ Commit and push changes
      run: |
        echo "æ£€æŸ¥æ–‡ä»¶å˜æ›´..."
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add output/
        
        # æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´éœ€è¦æäº¤
        if git diff --staged --quiet; then
          echo "ğŸ“­ æ²¡æœ‰æ£€æµ‹åˆ°æ–‡ä»¶å˜æ›´ï¼Œè·³è¿‡æäº¤"
        else
          echo "æ­£åœ¨æäº¤å˜æ›´..."
          git commit -m "Auto-update: Process channel lists $(date +'%Y-%m-%d %H:%M:%S')"
          git push origin master
          echo "âœ… å˜æ›´å·²æˆåŠŸæ¨é€åˆ°ä»“åº“"
        fi

          
Sync to Gitee

on:
  push:
    branches: [ master ]
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  sync-to-gitee:
    runs-on: ubuntu-latest
    name: ğŸš€ GitHub to Gitee Sync
    
    steps:
      # æ­¥éª¤1: æ£€å‡ºGitHubä»“åº“ä»£ç 
      - name: ğŸ“¥ Checkout GitHub Repository
        uses: actions/checkout@v4
        with:
          ref: master
          fetch-depth: 0  # è·å–å®Œæ•´å†å²è®°å½•
        
      # æ­¥éª¤2: ä¸‹è½½éœ€è¦åŒæ­¥çš„æ–‡ä»¶
      - name: â¬‡ï¸ Download Source Files
        run: |
          echo "å¼€å§‹ä¸‹è½½éœ€è¦åŒæ­¥çš„æ–‡ä»¶..."
          
          # ä¸‹è½½IPv4æ–‡æœ¬æ–‡ä»¶
          echo "æ­£åœ¨ä¸‹è½½ IPV4.txt..."
          curl -f -o IPV4.txt "https://raw.githubusercontent.com/${{ github.repository }}/master/output/userresult.txt"
          if [ $? -eq 0 ]; then
            echo "âœ… IPV4.txt ä¸‹è½½æˆåŠŸ"
            ls -la IPV4.txt
          else
            echo "âŒ IPV4.txt ä¸‹è½½å¤±è´¥"
            exit 1
          fi
          
          # ä¸‹è½½IPv6æ–‡æœ¬æ–‡ä»¶
          echo "æ­£åœ¨ä¸‹è½½ IPV6.txt..."
          curl -f -o IPV6.txt "https://raw.githubusercontent.com/${{ github.repository }}/master/output/ipv6/result.txt"
          if [ $? -eq 0 ]; then
            echo "âœ… IPV6.txt ä¸‹è½½æˆåŠŸ"
            ls -la IPV6.txt
          else
            echo "âŒ IPV6.txt ä¸‹è½½å¤±è´¥"
            exit 1
          fi
          
          # ä¸‹è½½IPv4æ’­æ”¾åˆ—è¡¨æ–‡ä»¶
          echo "æ­£åœ¨ä¸‹è½½ IPV4.m3u..."
          curl -f -o IPV4.m3u "https://raw.githubusercontent.com/${{ github.repository }}/master/output/userresult.m3u"
          if [ $? -eq 0 ]; then
            echo "âœ… IPV4.m3u ä¸‹è½½æˆåŠŸ"
            ls -la IPV4.m3u
          else
            echo "âŒ IPV4.m3u ä¸‹è½½å¤±è´¥"
            exit 1
          fi
          
          echo "ğŸ‰ æ‰€æœ‰æ–‡ä»¶ä¸‹è½½å®Œæˆï¼"
          echo "ä¸‹è½½çš„æ–‡ä»¶åˆ—è¡¨ï¼š"
          ls -la *.txt *.m3u
        
      # æ­¥éª¤3: å…‹éš†Giteeç›®æ ‡ä»“åº“
      - name: ğŸ¯ Clone Gitee Repository
        env:
          GITEE_USER: ${{ secrets.GITEE_USER }}
          GITEE_TOKEN: ${{ secrets.GITEE_TOKEN }}
          GITEE_REPO: ${{ secrets.GITEE_REPO }}
        run: |
          echo "å¼€å§‹å…‹éš†Giteeä»“åº“..."
          echo "ä»“åº“åœ°å€: gitee.com/${GITEE_USER}/${GITEE_REPO}"
          
          # æ£€æŸ¥å¿…è¦çš„å¯†é’¥æ˜¯å¦å­˜åœ¨
          if [ -z "$GITEE_USER" ] || [ -z "$GITEE_TOKEN" ] || [ -z "$GITEE_REPO" ]; then
            echo "âŒ ç¼ºå°‘å¿…è¦çš„Giteeé…ç½®å¯†é’¥ï¼Œè¯·æ£€æŸ¥ä»¥ä¸‹å¯†é’¥æ˜¯å¦è®¾ç½®ï¼š"
            echo "   - GITEE_USER: ${GITEE_USER:+-}"
            echo "   - GITEE_TOKEN: ${GITEE_TOKEN:+-}"
            echo "   - GITEE_REPO: ${GITEE_REPO:+-}"
            exit 1
          fi
          
          # å…‹éš†ä»“åº“
          git clone "https://${GITEE_USER}:${GITEE_TOKEN}@gitee.com/${GITEE_USER}/${GITEE_REPO}.git" gitee-repo
          
          if [ $? -eq 0 ]; then
            echo "âœ… Giteeä»“åº“å…‹éš†æˆåŠŸ"
            echo "ä»“åº“å†…å®¹ï¼š"
            ls -la gitee-repo/
          else
            echo "âŒ Giteeä»“åº“å…‹éš†å¤±è´¥"
            exit 1
          fi
        
      # æ­¥éª¤4: åŒæ­¥æ–‡ä»¶åˆ°Giteeä»“åº“
      - name: ğŸ”„ Sync Files to Gitee
        run: |
          echo "å¼€å§‹åŒæ­¥æ–‡ä»¶åˆ°Giteeä»“åº“..."
          cd gitee-repo
          
          # é…ç½®Gitç”¨æˆ·ä¿¡æ¯
          echo "é…ç½®Gitç”¨æˆ·ä¿¡æ¯..."
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@users.noreply.github.com"
          
          # åˆ‡æ¢åˆ°masteråˆ†æ”¯ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™åˆ›å»º
          echo "æ£€æŸ¥åˆ†æ”¯çŠ¶æ€..."
          git checkout master || git checkout -b master
          echo "âœ… å·²åˆ‡æ¢åˆ°masteråˆ†æ”¯"
          
          # å¤‡ä»½åŸæœ‰æ–‡ä»¶ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
          echo "å¤‡ä»½åŸæœ‰æ–‡ä»¶..."
          for file in IPV4.txt IPV6.txt IPV4.m3u; do
            if [ -f "$file" ]; then
              cp "$file" "${file}.backup"
              echo "ğŸ“¦ å·²å¤‡ä»½ $file"
            fi
          done
          
          # å¤åˆ¶æ–°æ–‡ä»¶
          echo "å¤åˆ¶æ–°æ–‡ä»¶..."
          cp ../IPV4.txt ./
          cp ../IPV6.txt ./
          cp ../IPV4.m3u ./
          
          echo "âœ… æ–‡ä»¶å¤åˆ¶å®Œæˆ"
          echo "åŒæ­¥çš„æ–‡ä»¶åˆ—è¡¨ï¼š"
          ls -la IPV4.txt IPV6.txt IPV4.m3u
          
          # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦æœ‰å˜åŒ–
          echo "æ£€æŸ¥æ–‡ä»¶å˜æ›´..."
          git status
          
          # æ·»åŠ æ–‡ä»¶åˆ°æš‚å­˜åŒº
          echo "æ·»åŠ æ–‡ä»¶åˆ°Git..."
          git add IPV4.txt IPV6.txt IPV4.m3u
          
          # æäº¤å˜æ›´
          echo "æäº¤å˜æ›´..."
          if git diff-index --quiet HEAD --; then
            echo "ğŸ“ æ²¡æœ‰æ£€æµ‹åˆ°æ–‡ä»¶å˜æ›´ï¼Œè·³è¿‡æäº¤"
          else
            git commit -m "ğŸ”„ Auto Sync from GitHub - $(date '+%Y-%m-%d %H:%M:%S')
            if [ $? -eq 0 ]; then
              echo "âœ… å˜æ›´æäº¤æˆåŠŸ"
              echo "æäº¤ä¿¡æ¯ï¼š"
              git log -1 --oneline
            else
              echo "âŒ å˜æ›´æäº¤å¤±è´¥"
              exit 1
            fi
          fi
        
      # æ­¥éª¤5: æ¨é€å˜æ›´åˆ°Gitee
      - name: ğŸš€ Push to Gitee
        run: |
          echo "å¼€å§‹æ¨é€å˜æ›´åˆ°Gitee..."
          cd gitee-repo
          
          # æ£€æŸ¥æ˜¯å¦æœ‰éœ€è¦æ¨é€çš„æäº¤
          LOCAL=$(git rev-parse @)
          REMOTE=$(git rev-parse @{u})
          BASE=$(git merge-base @ @{u})
          
          if [ $LOCAL = $REMOTE ]; then
            echo "ğŸ“­ æœ¬åœ°å’Œè¿œç¨‹åˆ†æ”¯ä¸€è‡´ï¼Œæ— éœ€æ¨é€"
          elif [ $LOCAL = $BASE ]; then
            echo "ğŸ”„ éœ€è¦æ‹‰å–è¿œç¨‹æ›´æ–°"
          elif [ $REMOTE = $BASE ]; then
            echo "æ­£åœ¨æ¨é€å˜æ›´..."
            git push origin master
            if [ $? -eq 0 ]; then
              echo "ğŸ‰ åŒæ­¥å®Œæˆï¼æ–‡ä»¶å·²æˆåŠŸæ¨é€åˆ°Gitee"
              echo "ğŸ“Š åŒæ­¥ç»Ÿè®¡ï¼š"
              echo "   - IPV4.txt: $(stat -c%s IPV4.txt) bytes"
              echo "   - IPV6.txt: $(stat -c%s IPV6.txt) bytes"
              echo "   - IPV4.m3u: $(stat -c%s IPV4.m3u) bytes"
            else
              echo "âŒ æ¨é€å¤±è´¥"
              exit 1
            fi
          else
            echo "âš ï¸  åˆ†æ”¯å‡ºç°åˆ†æ­§ï¼Œéœ€è¦æ‰‹åŠ¨å¤„ç†"
            exit 1
          fi
        
      # æ­¥éª¤6: æ¸…ç†å·¥ä½œ
      - name: ğŸ§¹ Cleanup
        if: always()
        run: |
          echo "æ‰§è¡Œæ¸…ç†å·¥ä½œ..."
          rm -rf gitee-repo
          rm -f IPV4.txt IPV6.txt IPV4.m3u
          echo "âœ… æ¸…ç†å®Œæˆ"
