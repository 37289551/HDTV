
name: List Merge

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  merge-channels:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Create directory structure
      run: |
        mkdir -p output
        echo "Directory structure created"
        
    - name: Download remote channel list
      run: |
        curl -s -o remote.txt https://raw.githubusercontent.com/jerome158/CHN/refs/heads/main/YD.txt
        echo "Remote channel list downloaded"
        
    - name: Initialize local file
      run: |
        if [ ! -f output/userresult.txt ]; then
          touch output/userresult.txt
          echo "Created new local channel file"
        else
          echo "Using existing local channel file"
          echo "Current line count: $(wc -l < output/userresult.txt)"
        fi
        
    - name: Safe merge channel lists
      run: |
        # Create temporary working file
        cp output/userresult.txt temp_merged.txt
        
        # Count initial lines
        initial_lines=$(wc -l < temp_merged.txt)
        echo "Initial channel count: $initial_lines"
        
        # Process remote channel list
        changes_made=false
        while IFS= read -r remote_line || [ -n "$remote_line" ]; do
          [ -z "$remote_line" ] && continue
          
          remote_channel=$(echo "$remote_line" | cut -d',' -f1)
          remote_url=$(echo "$remote_line" | cut -d',' -f2)
          
          if [ -z "$remote_channel" ] || [ -z "$remote_url" ]; then
            echo "Skipping invalid line: $remote_line"
            continue
          fi
          
          # Check if exactly the same line exists
          if grep -Fxq "$remote_line" temp_merged.txt; then
            echo "Skipping identical line: $remote_channel"
            continue
          fi
          
          # Find all lines with same channel name
          matching_lines=$(grep -n "^$remote_channel," temp_merged.txt)
          
          if [ -n "$matching_lines" ]; then
            # Check if URL already exists
            url_exists=false
            while IFS= read -r match_info; do
              [ -z "$match_info" ] && continue
              existing_url=$(echo "$match_info" | cut -d':' -f2- | cut -d',' -f2)
              if [ "$existing_url" = "$remote_url" ]; then
              url_exists=true
              break
            fi
            done <<< "$matching_lines"
            
            if [ "$url_exists" = false ]; then
              # Get the last matching line number
              last_line_info=$(echo "$matching_lines" | tail -1)
              last_line_num=$(echo "$last_line_info" | cut -d':' -f1)
              
              # Insert new line after the last matching channel
              awk -v line_num="$last_line_num" -v new_line="$remote_line" '
                NR == line_num { print $0; print new_line; next }
                { print $0 }
              ' temp_merged.txt > temp_merged2.txt
              mv temp_merged2.txt temp_merged.txt
              changes_made=true
              echo "Added new URL for channel: $remote_channel"
            fi
          else
            echo "No matching channel found: $remote_channel"
          fi
        done < remote.txt
        
        # Check if there are changes
        final_lines=$(wc -l < temp_merged.txt)
        if [ "$initial_lines" -eq "$final_lines" ]; then
            echo "No changes detected for merging"
            rm temp_merged.txt
        else
            mv temp_merged.txt output/userresult.txt
            echo "Safe merge completed. Final channel count: $final_lines"
        fi
        
    - name: Display results
      run: |
        echo "=== Merge Results Preview ==="
        head -10 output/userresult.txt
        echo "..."
        tail -5 output/userresult.txt
        echo "===================="
        
    - name: Commit and push changes
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        git add output/userresult.txt
        if git diff --staged --quiet; then
          echo "No changes to commit"
        else
          git commit -m "Auto-update: Safe channel list merge $(date +'%Y-%m-%d %H:%M:%S')"
          git push
        fi

