name: Merge Channel Lists
on:
  schedule:
  - cron: '0 0 * * *' # 每天UTC时间0点（北京时间8点）触发
  workflow_dispatch: # 支持手动触发

jobs:
  merge-channels:
   runs-on: ubuntu-latest


   steps:
   - name: Checkout repository
     uses: actions/checkout@v4
     with:
       ref: master
   - name: Fetch remote channel list
     run: |
      curl -s -o remote.txt https://raw.githubusercontent.com/jerome158/CHN/refs/heads/main/YD.txt
    
   - name: Merge
     run: |
       mkdir -p output
       if [ ! -f output/userresult.txt ]; then
           touch output/userresult.txt
       fi
 
       while IFS= read -r remote_line; do
         if [ -n "$remote_line" ]; then
            remote_channel=$(echo "$remote_line" | cut -d',' -f1)
            remote_url=$(echo "$remote_line" | cut -d',' -f2)
            existing_line=$(grep "^$remote_channel," output/userresult.txt)
        
            if [ -n "$existing_line" ]; then
               existing_url=$(echo "$existing_line" | cut -d',' -f2)
               if [ "$remote_url" != "$existing_url" ]; then
                  sed -i "/^$remote_channel,/d" output/userresult.txt
                  echo "$remote_channel,$existing_url;$remote_url" >> output/userresult.txt
               fi
            else
               :
           fi
       fi
          done < remote.txt
    
   - name: Commit and push changes
     run: |
         git config --local user.email "action@github.com"
         git config --local user.name "GitHub Action"
         git add output/userresult.txt
         git diff --staged --quiet || git commit -m "Auto-update channel list [skip ci]"
         git push

   - name: Clone Gitee Repo
     env:
          GITEE_USER: ${{ secrets.GITEE_USER }}
          GITEE_TOKEN: ${{ secrets.GITEE_TOKEN }}
          GITEE_REPO: ${{ secrets.GITEE_REPO }}
     run: |
          git clone "https://${GITEE_USER}:${GITEE_TOKEN}@gitee.com/${GITEE_USER}/${GITEE_REPO}.git" gitee-repo

   - name: Sync files
     run: |
          cd gitee-repo
          git config user.name "GitHub Actions"
          git config user.email "actions@users.noreply.github.com"
          git checkout master || git checkout -b master
          cp ../IPV4.txt ./
          # cp ../IPV6.txt ./
          # cp ../IPV4.m3u ./
          git add IPV4.txt 
          # add to above line IPV6.txt IPV4.m3u
          git commit -m "Sync from GitHub" || exit 0
          git push origin master
