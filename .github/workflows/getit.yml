name: convert-m3u

on:
  schedule:
    - cron: '0 */2 * * *'  # 每两小时执行一次
  workflow_dispatch:  # 允许手动触发

jobs:
  process-channels:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        ref: master

    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: "3.10"

    - name: Install dependencies
      run: pip install requests

    - name: Download and process m3u file
      run: |
        mkdir -p output
        python << 'EOF'
        import requests
        import re
        
        # 下载远程m3u文件
        url = "https://raw.githubusercontent.com/develop202/migu_video/refs/heads/main/interface.txt"
        response = requests.get(url)
        m3u_content = response.text
        
        # 解析m3u格式并转换为txt标准格式
        lines = m3u_content.split('\n')
        output_lines = []
        
        # CCTV频道名称标准化映射
        channel_mapping = {
            "CCTV1综合": "CCTV-1",
            "CCTV2财经": "CCTV-2", 
            "CCTV3综艺": "CCTV-3",
            "CCTV4中文国际": "CCTV-4",
            "CCTV5体育": "CCTV-5",
            "CCTV5+体育赛事": "CCTV-5+",
            "CCTV6电影": "CCTV-6",
            "CCTV7国防军事": "CCTV-7",
            "CCTV8电视剧": "CCTV-8",
            "CCTV9纪录": "CCTV-9",
            "CCTV10科教": "CCTV-10",
            "CCTV11戏曲": "CCTV-11",
            "CCTV12社会与法": "CCTV-12",
            "CCTV13新闻": "CCTV-13",
            "CCTV14少儿": "CCTV-14",
            "CCTV15音乐": "CCTV-15",
            "CCTV16奥林匹克": "CCTV-16",
            "CCTV17农业农村": "CCTV-17",
            "CCTV4欧洲": "CCTV欧洲",
            "CCTV4美洲":"CCTV美洲",
            "CGTN外语纪录":"CGTN英语",
            "CETV1":"CETV-1",
            "CETV2":"CETV-2",
        }
        
        current_channel = None
        for line in lines:
            line = line.strip()
            if line.startswith('#EXTINF:'):
                # 提取频道名称
                match = re.search(r',(.+)$', line)
                if match:
                    current_channel = match.group(1)
                    # 应用频道映射
                    for old_name, new_name in channel_mapping.items():
                        if old_name in current_channel:
                            current_channel = current_channel.replace(old_name, new_name)
            elif line.startswith('http'):
                if current_channel:
                    output_lines.append(f"{current_channel}, {line}")
                    current_channel = None
        
        # 清空原文件内容并写入新内容
        with open('output/remote.txt', 'w', encoding='utf-8') as f:
            f.write('\n'.join(output_lines))
        
        print(f"成功处理 {len(output_lines)} 个频道")
        EOF

    - name: Merge channels to user result
      run: |
        python << 'EOF'
        import os
        
        def read_channels(filename):
            """读取频道文件，返回频道字典"""
            if not os.path.exists(filename):
                return {}
            
            channels = {}
            with open(filename, 'r', encoding='utf-8') as f:
                for line in f:
                    line = line.strip()
                    if line and ',' in line:
                        name, url = line.split(',', 1)
                        channels[name.strip()] = url.strip()
            return channels
        
        def write_channels(filename, channels):
            """将频道字典写入文件"""
            with open(filename, 'w', encoding='utf-8') as f:
                for name, url in channels.items():
                    f.write(f"{name}, {url}\n")
        
        # 读取remote.txt和userresult.txt
        remote_channels = read_channels('output/remote.txt')
        user_channels = read_channels('output/userresult.txt')
        
        # 处理频道合并
        for remote_name, remote_url in remote_channels.items():
            if remote_name in user_channels:
                # 检查现有频道地址是否以特定前缀开头
                existing_url = user_channels[remote_name]
                if existing_url.startswith('http://gslbmgsplive.miguvideo.com'):
                    # 替换频道
                    user_channels[remote_name] = remote_url
                    print(f"替换频道: {remote_name}")
                else:
                    # 添加到前面（这里实现为保持原有顺序，但标记已处理）
                    user_channels[remote_name] = remote_url
                    print(f"更新频道: {remote_name}")
            # 如果目标文件不存在相同频道，则不添加
        
        # 写入合并后的结果
        write_channels('output/userresult.txt', user_channels)
        print(f"合并完成，共处理 {len(user_channels)} 个频道")
        EOF

    - name: Commit and push changes
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add output/
        git diff --staged --quiet || git commit -m "Auto-update: Process channel lists $(date +'%Y-%m-%d %H:%M:%S')"
        git push origin master
          
  sync-to-gitee:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout GitHub Repo
        uses: actions/checkout@v4
        with:
          ref: master
       
      - name: Download files
        run: |
          curl -o IPV4.txt "https://raw.githubusercontent.com/${{ github.repository }}/master/output/userresult.txt"
          curl -o IPV6.txt "https://raw.githubusercontent.com/${{ github.repository }}/master/output/ipv6/result.txt"
          curl -o IPV4.m3u "https://raw.githubusercontent.com/${{ github.repository }}/master/output/userresult.m3u"

      - name: Clone Gitee Repo
        env:
          GITEE_USER: ${{ secrets.GITEE_USER }}
          GITEE_TOKEN: ${{ secrets.GITEE_TOKEN }}
          GITEE_REPO: ${{ secrets.GITEE_REPO }}
        run: |
          git clone "https://${GITEE_USER}:${GITEE_TOKEN}@gitee.com/${GITEE_USER}/${GITEE_REPO}.git" gitee-repo

      - name: Sync files
        run: |
          cd gitee-repo
          git config user.name "GitHub Actions"
          git config user.email "actions@users.noreply.github.com"
          git checkout master || git checkout -b master
          cp ../IPV4.txt ./
          cp ../IPV6.txt ./
          cp ../IPV4.m3u ./
          git add IPV4.txt IPV6.txt IPV4.m3u
          git commit -m "Sync from GitHub" || exit 0
          git push origin master
