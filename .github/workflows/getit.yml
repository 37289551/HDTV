name: YD Merge

on:
  schedule:
    - cron: '0 0 * * *'  # 每天UTC时间0点（北京时间8点）
  workflow_dispatch:     # 支持手动触发

jobs:
  merge-channels:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Create directory structure
      run: |
        mkdir -p output
        
    - name: Download remote channel list
      run: |
        curl -s -o remote.txt https://raw.githubusercontent.com/jerome158/CHN/refs/heads/main/YD.txt
        echo "远程频道列表下载完成，文件行数: $(wc -l < remote.txt)"
        
    - name: Initialize userresult.txt
      run: |
        if [ ! -f output/userresult.txt ]; then
          echo "创建新的userresult.txt文件"
          touch output/userresult.txt
        else
          echo "使用现有的userresult.txt文件，当前行数: $(wc -l < output/userresult.txt)"
        fi
        
    - name: merge
      run: |
        cp output/userresult.txt temp_result.txt
        
        while IFS= read -r remote_line || [ -n "$remote_line" ]; do
          [ -z "$remote_line" ] && continue
          
          remote_channel=$(echo "$remote_line" | cut -d',' -f1)
          remote_url=$(echo "$remote_line" | cut -d',' -f2)
          
          if [ -z "$remote_channel" ] || [ -z "$remote_url" ]; then
            echo "跳过无效行: $remote_line"
            continue
          fi

          if grep -q "^$remote_line$" temp_result.txt; then
            echo "跳过完全相同的行: $remote_channel"
            continue
          fi

          existing_line=$(grep "^$remote_channel," temp_result.txt | head -1)
          
          if [ -n "$existing_line" ]; then
            existing_url=$(echo "$existing_line" | cut -d',' -f2)

            if [ "$remote_url" != "$existing_url" ]; then
              echo "$remote_line" >> temp_result.txt
              echo "添加新URL行: $remote_channel - $remote_url"
            else
              echo "跳过相同频道和URL: $remote_channel"
            fi
          else
            echo "没有找到匹配频道: $remote_channel（保持现有内容不变）"
          fi
        done < remote.txt

        if diff output/userresult.txt temp_result.txt > /dev/null; then
          echo "没有检测到需要合并的更改"
          rm temp_result.txt
        else
          mv temp_result.txt output/userresult.txt
          echo "安全合并完成，最终文件行数: $(wc -l < output/userresult.txt)"
        fi
        
    - name: Commit and push changes
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        git add output/userresult.txt
        if git diff --staged --quiet; then
          echo "没有变化需要提交"
        else
          git commit -m "Auto-update: 安全合并频道列表 $(date +'%Y-%m-%d %H:%M:%S')"
          git push
        fi
