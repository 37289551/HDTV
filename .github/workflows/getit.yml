name: Sync Handle
on:
  schedule:
    - cron: '56 1-23/2 * * *'  #  
  workflow_dispatch:  #  Mannual trigger allowed

jobs:
  convert-m3u:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: 检出代码
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: CREATE DIR
        run: mkdir -p output

      - name: Check trigger type
        id: check_trigger
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "Manual force to run!"
            echo "should_execute=true" >> $GITHUB_OUTPUT
          else
            echo "Auto trigger, check time!"
            echo "should_execute=false" >> $GITHUB_OUTPUT
          fi    
      - name: Wait for even hour
        id: hour_check
        if: steps.check_trigger.outputs.should_execute == 'false'
        run: |
          while true; do
            CURRENT_HOUR_UTC=$(date -u +%H)
            echo "Current UTC hour: $CURRENT_HOUR_UTC"
            # 移除前导零
            HOUR_WITHOUT_ZERO=${CURRENT_HOUR_UTC##*0}
            if [ $((HOUR_WITHOUT_ZERO % 2)) -eq 0 ]; then
              echo "Even hour detected, continuing execution"
              echo "is_even_hour=true" >> $GITHUB_OUTPUT
              break
            else
              echo "Odd hour, waiting 30 seconds..."
              sleep 30
            fi
          done
          
      - name: DOWNLOAD
        if: steps.check_trigger.outputs.should_execute == 'true' || steps.hour_check.outputs.is_even_hour == 'true'
        run: |
          > output/remote.txt
          # DOWNLOAD & FORMATING
          curl -s "https://raw.githubusercontent.com/develop202/migu_video/refs/heads/main/interface.txt" -o input.m3u
          awk -F',' '/^#EXTINF:/ { 
              gsub(/^#EXTINF:.*,/, ""); 
              channel_name = $0; 
              getline; 
              if ($0 !~ /^#/) {
                  gsub(/CCTV1综合/, "CCTV-1", channel_name);
                  gsub(/CCTV2财经/, "CCTV-2", channel_name);
                  gsub(/CCTV3综艺/, "CCTV-3", channel_name);
                  gsub(/CCTV4中文国际/, "CCTV-4", channel_name);
                  gsub(/CCTV5体育/, "CCTV-5", channel_name);
                  gsub(/CCTV5\+体育赛事/, "CCTV-5+", channel_name);
                  gsub(/CCTV6电影/, "CCTV-6", channel_name);
                  gsub(/CCTV7国防军事/, "CCTV-7", channel_name);
                  gsub(/CCTV8电视剧/, "CCTV-8", channel_name);
                  gsub(/CCTV9纪录/, "CCTV-9", channel_name);
                  gsub(/CCTV10科教/, "CCTV-10", channel_name);
                  gsub(/CCTV11戏曲/, "CCTV-11", channel_name);
                  gsub(/CCTV12社会与法/, "CCTV-12", channel_name);
                  gsub(/CCTV13新闻/, "CCTV-13", channel_name);
                  gsub(/CCTV14少儿/, "CCTV-14", channel_name);
                  gsub(/CCTV15音乐/, "CCTV-15", channel_name);
                  gsub(/CCTV16奥林匹克/, "CCTV-16", channel_name);
                  gsub(/CCTV17农业农村/, "CCTV-17", channel_name);
                  gsub(/CCTV4欧洲/, "CCTV欧洲", channel_name);
                  gsub(/CCTV4美洲/, "CCTV美洲", channel_name);
                  gsub(/CGTN外语纪录/, "CGTN记录", channel_name);
                  gsub(/CETV1/, "CETV-1", channel_name);
                  gsub(/CETV2/, "CETV-2", channel_name);
                  gsub(/熊猫频道1/, "熊猫频道", channel_name);
                  gsub(/经典香港电影/, "港片经典", channel_name);
                  gsub(/抗战经典影片/, "抗战影片", channel_name);
                  gsub(/CHC影迷电影/, "CHC影院", channel_name);
                  gsub(/和美乡途轮播台/, "经典影片", channel_name);
                  gsub(/新片放映厅/, "新片放映", channel_name);
                  
                  print channel_name "," $0 >> "output/remote.txt"
              }
          }' input.m3u

      - name: ADD TO OUTPUT
        run: |
          echo "开始合并频道列表..."
        
          # 检查文件是否存在
          if [[ ! -f "output/remote.txt" ]]; then
            echo "错误: output/remote.txt 文件未找到"
            exit 1
          fi

          if [[ ! -f "output/userresult.txt" ]]; then
            echo "错误: output/userresult.txt 文件未找到"
            exit 1
          fi

          # 创建备份
          cp output/userresult.txt output/userresult.txt.backup
        
          # 处理频道合并
          temp_result=$(mktemp)
          processed=false
        
          # 读取userresult.txt到临时结果文件
          cp output/userresult.txt "$temp_result"
        
          # 读取remote.txt中的频道
          while IFS= read -r remote_channel; do
            [[ -z "$remote_channel" ]] && continue
          
            # 提取频道名称（第一个逗号前的部分）
            remote_name=$(echo "$remote_channel" | cut -d',' -f1 | tr -d '\r')
          
            # 在userresult.txt中查找相同名称的频道
            matching_line=$(grep -n "^$remote_name," "$temp_result" | head -1)
          
            if [[ -n "$matching_line" ]]; then
              processed=true
              echo "找到匹配频道: $remote_name"
            
              # 获取匹配的行号和内容
              line_num=$(echo "$matching_line" | cut -d: -f1)
              matching_channel=$(echo "$matching_line" | cut -d: -f2-)
            
              # 提取匹配频道的URL地址
              matching_url=$(echo "$matching_channel" | cut -d',' -f2- | tr -d '\r')
            
              # 检查匹配的频道URL是否以https://gstdtree开头
              if [[ "$matching_url" == http://gslbmgsplive* ]]; then
                 echo "  → gstdtree频道: 添加后删除原有频道"
              # 在匹配行前添加remote_channel
                sed "${line_num}i$remote_channel" "$temp_result" > "$temp_result.tmp"
                mv "$temp_result.tmp" "$temp_result"
          
                # 删除原有的gstdtree频道
                sed "${line_num}d" "$temp_result" > "$temp_result.tmp"
                mv "$temp_result.tmp" "$temp_result"
              else
                echo "  → 普通频道: 添加到匹配频道前"
                # 在匹配行前添加remote_channel
                sed "${line_num}i$remote_channel" "$temp_result" > "$temp_result.tmp"
                 mv "$temp_result.tmp" "$temp_result"
            	fi
            else
              echo "未找到匹配频道: $remote_name，跳过"
            fi
          
          done < "output/remote.txt"

          # 移动处理结果到userresult.txt
          mv "$temp_result" output/userresult.txt
        
          echo "频道合并完成"
          echo "处理前行数: $(wc -l < output/userresult.txt.backup)"
          echo "处理后行数: $(wc -l < output/userresult.txt)"
          
      - name: COMMIT THE CHANGES
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add output/
          git diff --staged --quiet || git commit -m "UPdated: CH List $(date +'%Y-%m-%d %H:%M:%S')"
          git push


  sync-to-gitee:
    runs-on: ubuntu-latest
    needs: convert-m3u 
    
    steps:
      - name: Checkout GitHub Repo
        uses: actions/checkout@v4
        with:
          ref: master
       
      - name: Download files
        run: |
          curl -o IPV4.txt "https://raw.githubusercontent.com/${{ github.repository }}/master/output/userresult.txt"
          # curl -o IPV6.txt "https://raw.githubusercontent.com/${{ github.repository }}/master/output/ipv6/result.txt"
          # curl -o IPV4.m3u "https://raw.githubusercontent.com/${{ github.repository }}/master/output/userresult.m3u"

      - name: Clone Gitee Repo
        env:
          GITEE_USER: ${{ secrets.GITEE_USER }}
          GITEE_TOKEN: ${{ secrets.GITEE_TOKEN }}
          GITEE_REPO: ${{ secrets.GITEE_REPO }}
        run: |
          git clone "https://${GITEE_USER}:${GITEE_TOKEN}@gitee.com/${GITEE_USER}/${GITEE_REPO}.git" gitee-repo

      - name: Sync files
        run: |
          cd gitee-repo
          git config user.name "GitHub Actions"
          git config user.email "actions@users.noreply.github.com"
          git checkout master || git checkout -b master
          cp ../IPV4.txt ./
          # cp ../IPV6.txt ./
          # cp ../IPV4.m3u ./
          git add IPV4.txt 
          # add to above line IPV6.txt IPV4.m3u
          git commit -m "Sync from GitHub" || exit 0
          git push origin master
