
name: List Merge

on:
  schedule:
    - cron: '0 0 * * *'  # 每天UTC时间0点（北京时间8点）
  workflow_dispatch:     # 支持手动触发

jobs:
  merge-channels:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Create directory structure
      run: |
        mkdir -p output
        echo "目录结构创建完成"
        
    - name: Download remote channel list
      run: |
        curl -s -o remote.txt https://raw.githubusercontent.com/jerome158/CHN/refs/heads/main/YD.txt
        echo "远程频道列表下载完成，文件行数: $(wc -l < remote.txt)"
        
    - name: Initialize userresult.txt
      run: |
        if [ ! -f output/userresult.txt ]; then
          echo "创建新的userresult.txt文件"
          touch output/userresult.txt
        else
          echo "使用现有的userresult.txt文件，当前行数: $(wc -l < output/userresult.txt)"
        fi
        
    - name: Safe merge channel lists
      run: |
        # 创建临时工作文件
        cp output/userresult.txt temp_result.txt
        
        # 处理远程频道列表
        while IFS= read -r remote_line || [ -n "$remote_line" ]; do
          [ -z "$remote_line" ] && continue
          
          remote_channel=$(echo "$remote_line" | cut -d',' -f1)
          remote_url=$(echo "$remote_line" | cut -d',' -f2)
          
          if [ -z "$remote_channel" ] || [ -z "$remote_url" ]; then
            echo "跳过无效行: $remote_line"
            continue
          fi
          
          # 检查是否已存在完全相同的行
          if grep -q "^$remote_line$" temp_result.txt; then
              echo "跳过完全相同的行: $remote_channel"
              continue
          fi
          
          # 检查是否已存在相同频道名
          existing_lines=$(grep -n "^$remote_channel," temp_result.txt)
          
          if [ -n "$existing_lines" ]; then
            # 获取最后一个相同频道的行号
            last_line_number=$(echo "$existing_lines" | tail -1 | cut -d':' -f1)
            existing_url=$(echo "$existing_lines" | tail -1 | cut -d':' -f2- | cut -d',' -f2)
            
            # 如果URL不同，则在最后一个相同频道下方插入新行
            if [ "$remote_url" != "$existing_url" ]; then
              # 使用awk在指定行后插入新行
              awk -v line_num="$last_line_number" -v new_line="$remote_line" '
                  NR == line_num { print $0; print new_line; next }
                  { print $0 }
                ' temp_result.txt > temp_result2.txt && mv temp_result2.txt temp_result.txt
              echo "在频道 $remote_channel 下方添加新URL: $remote_url"
            else
              echo "跳过相同频道和URL: $remote_channel"
            fi
          else
            echo "没有找到匹配频道: $remote_channel（保持现有内容不变）"
          fi
        done < remote.txt
        
        # 检查是否有实际变化
        if diff output/userresult.txt temp_result.txt > /dev/null; then
          echo "没有检测到需要合并的更改"
          rm temp_result.txt
        else
          mv temp_result.txt output/userresult.txt
          echo "安全合并完成，最终文件行数: $(wc -l < output/userresult.txt)"
        fi
        
    - name: Display final results
      run: |
        echo "=== 最终频道列表 ==="
        cat output/userresult.txt
        echo "===================="
        
    - name: Commit and push changes
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        git add output/userresult.txt
        if git diff --staged --quiet; then
          echo "没有变化需要提交"
        else
          git commit -m "Auto-update: 安全合并频道列表 $(date +'%Y-%m-%d %H:%M:%S')"
          git push
          echo "安全合并更改已提交"
        fi

