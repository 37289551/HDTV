name: Sync Handle
on:
  schedule:
    - cron: '56 1-23/2 * * *'  #  
  workflow_dispatch:  #  Mannual trigger allowed

jobs:
  convert-m3u:
    runs-on: ubuntu-latest
    steps:
      - name: 检出代码
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: 创建输出目录
        run: mkdir -p output

      - name: 下载M3U文件
        run: |
          curl -s "https://raw.githubusercontent.com/develop202/migu_video/refs/heads/main/interface.txt" -o input.m3u
          echo "下载完成，文件大小: $(wc -l < input.m3u) 行"

      - name: 转换M3U文件
        run: |
          echo "开始转换M3U文件..."
          # 清空或创建remote.txt
          > output/remote.txt
          
          # 使用awk处理M3U格式
          awk -F',' '
          /^#EXTINF:/ {
              extinf = $0;
              getline;
              if ($0 !~ /^#/) {
                  # 提取频道名称并清理
                  channel_name = extinf;
                  gsub(/^#EXTINF:[0-9]+,/, "", channel_name);
                  gsub(/^[[:space:]]+|[[:space:]]+$/, "", channel_name);
                  
                  # 标准化频道名称
                  gsub(/CCTV1综合/, "CCTV-1", channel_name);
                  gsub(/CCTV2财经/, "CCTV-2", channel_name);
                  gsub(/CCTV3综艺/, "CCTV-3", channel_name);
                  gsub(/CCTV4中文国际/, "CCTV-4", channel_name);
                  gsub(/CCTV5体育/, "CCTV-5", channel_name);
                  gsub(/CCTV5\+体育赛事/, "CCTV-5+", channel_name);
                  gsub(/CCTV6电影/, "CCTV-6", channel_name);
                  gsub(/CCTV7国防军事/, "CCTV-7", channel_name);
                  gsub(/CCTV8电视剧/, "CCTV-8", channel_name);
                  gsub(/CCTV9纪录/, "CCTV-9", channel_name);
                  gsub(/CCTV10科教/, "CCTV-10", channel_name);
                  gsub(/CCTV11戏曲/, "CCTV-11", channel_name);
                  gsub(/CCTV12社会与法/, "CCTV-12", channel_name);
                  gsub(/CCTV13新闻/, "CCTV-13", channel_name);
                  gsub(/CCTV14少儿/, "CCTV-14", channel_name);
                  gsub(/CCTV15音乐/, "CCTV-15", channel_name);
                  gsub(/CCTV16奥林匹克/, "CCTV-16", channel_name);
                  gsub(/CCTV17农业农村/, "CCTV-17", channel_name);
                  gsub(/CCTV4欧洲/, "CCTV欧洲", channel_name);
                  gsub(/CCTV4美洲/, "CCTV美洲", channel_name);
                  gsub(/CGTN外语纪录/, "CGTN记录", channel_name);
                  gsub(/CETV1/, "CETV-1", channel_name);
                  gsub(/CETV2/, "CETV-2", channel_name);
                  gsub(/熊猫频道1/, "熊猫频道", channel_name);
                  gsub(/经典香港电影/, "港片经典", channel_name);
                  gsub(/抗战经典影片/, "抗战影片", channel_name);
                  gsub(/CHC影迷电影/, "CHC影院", channel_name);
                  gsub(/和美乡途轮播台/, "经典影片", channel_name);
                  gsub(/新片放映厅/, "新片放映", channel_name);

                  
                  url = $0;
                  gsub(/^[[:space:]]+|[[:space:]]+$/, "", url);
                  
                  if (channel_name != "" && url != "") {
                      print channel_name "," url >> "output/remote.txt"
                  }
              }
          }' input.m3u
          
          echo "转换完成，remote.txt行数: $(wc -l < output/remote.txt)"

      - name: 智能合并到userresult.txt
        run: |
          echo "开始智能合并..."
          
          # 确保userresult.txt存在
          touch output/userresult.txt
          
          # 创建临时文件
          temp_file=$(mktemp)
          cp output/userresult.txt "$temp_file"
          
          # 处理remote.txt中的每一行
          while IFS= read -r line; do
              if [ -n "$line" ]; then
                  channel_name=$(echo "$line" | cut -d',' -f1)
                  new_url=$(echo "$line" | cut -d',' -f2)
                  
                  # 在userresult.txt中查找相同频道
                  found_line=$(grep -n "^$channel_name," "$temp_file" | head -1)
                  
                  if [ -n "$found_line" ]; then
                      line_num=$(echo "$found_line" | cut -d':' -f1)
                      original_line=$(echo "$found_line" | cut -d':' -f2-)
                      original_url=$(echo "$original_line" | cut -d',' -f2)
                      
                      # 检查URL是否以目标域名开头
                      if [[ "$original_url" == http://gslbmgsplive.miguvideo.com* ]]; then
                          # 整行替换 - 使用精确的sed命令
                          sed -i "${line_num}c\\$line" "$temp_file"
                          echo "替换频道: $channel_name"
                      else
                          # 在原有频道前插入新频道
                          sed -i "${line_num}i\\$line" "$temp_file"
                          echo "插入频道: $channel_name (在原有频道前)"
                      fi
                  else
                      echo "跳过频道: $channel_name (无重复)"
                  fi
              fi
          done < "output/remote.txt"
          
          # 更新userresult.txt
          mv "$temp_file" output/userresult.txt
          echo "合并完成，userresult.txt行数: $(wc -l < output/userresult.txt)"

      - name: 提交更改
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add output/
          git diff --staged --quiet || git commit -m "自动更新频道列表 $(date '+%Y-%m-%d %H:%M:%S')"
          git push
          
  sync-to-gitee:
    runs-on: ubuntu-latest
    needs: convert-m3u 
    
    steps:
      - name: Checkout GitHub Repo
        uses: actions/checkout@v4
        with:
          ref: master
       
      - name: Download files
        run: |
          curl -o IPV4.txt "https://raw.githubusercontent.com/${{ github.repository }}/master/output/userresult.txt"
          # curl -o IPV6.txt "https://raw.githubusercontent.com/${{ github.repository }}/master/output/ipv6/result.txt"
          # curl -o IPV4.m3u "https://raw.githubusercontent.com/${{ github.repository }}/master/output/userresult.m3u"

      - name: Clone Gitee Repo
        env:
          GITEE_USER: ${{ secrets.GITEE_USER }}
          GITEE_TOKEN: ${{ secrets.GITEE_TOKEN }}
          GITEE_REPO: ${{ secrets.GITEE_REPO }}
        run: |
          git clone "https://${GITEE_USER}:${GITEE_TOKEN}@gitee.com/${GITEE_USER}/${GITEE_REPO}.git" gitee-repo

      - name: Sync files
        run: |
          cd gitee-repo
          git config user.name "GitHub Actions"
          git config user.email "actions@users.noreply.github.com"
          git checkout master || git checkout -b master
          cp ../IPV4.txt ./
          # cp ../IPV6.txt ./
          # cp ../IPV4.m3u ./
          git add IPV4.txt 
          # add to above line IPV6.txt IPV4.m3u
          git commit -m "Sync from GitHub" || exit 0
          git push origin master
