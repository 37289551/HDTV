
name: Convert M3U Playlist

on:
  schedule:
    - cron: '2 */2 * * *'
  workflow_dispatch:
  push:
    branches: [master]
    paths:
      - 'output/**'

permissions:
  contents: write

jobs:
  convert-m3u:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: master
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Create output directory
        run: mkdir -p output

      - name: Download M3U file
        run: |
          curl -s "https://raw.githubusercontent.com/develop202/migu_video/refs/heads/main/interface.txt" -o input.m3u

      - name: Process M3U file to create remote.txt
        run: |
          # 清空remote.txt文件
          > output/remote.txt
          
          awk '
          /^#EXTINF:/ {
              info = $0;
              getline;
              if ($0 !~ /^#/) {
                  url = $0;
                  # 提取频道名称（去掉#EXTINF:后的数字和逗号）
                  gsub(/^#EXTINF:[0-9]+,/, "", info);
                  channel_name = info;
                  
                  # CCTV频道名称标准化
                  gsub(/CCTV1综合/, "CCTV-1", channel_name);
                  gsub(/CCTV2财经/, "CCTV-2", channel_name);
                  gsub(/CCTV3综艺/, "CCTV-3", channel_name);
                  gsub(/CCTV4中文国际/, "CCTV-4", channel_name);
                  gsub(/CCTV5体育/, "CCTV-5", channel_name);
                  gsub(/CCTV5\+体育赛事/, "CCTV-5+", channel_name);
                  gsub(/CCTV6电影/, "CCTV-6", channel_name);
                  gsub(/CCTV7国防军事/, "CCTV-7", channel_name);
                  gsub(/CCTV8电视剧/, "CCTV-8", channel_name);
                  gsub(/CCTV9纪录/, "CCTV-9", channel_name);
                  gsub(/CCTV10科教/, "CCTV-10", channel_name);
                  gsub(/CCTV11戏曲/, "CCTV-11", channel_name);
                  gsub(/CCTV12社会与法/, "CCTV-12", channel_name);
                  gsub(/CCTV13新闻/, "CCTV-13", channel_name);
                  gsub(/CCTV14少儿/, "CCTV-14", channel_name);
                  gsub(/CCTV15音乐/, "CCTV-15", channel_name);
                  gsub(/CCTV16奥林匹克/, "CCTV-16", channel_name);
                  gsub(/CCTV17农业农村/, "CCTV-17", channel_name);
                  
                  # 输出到remote.txt
                  print channel_name "," url >> "output/remote.txt"
              }
          }' input.m3u

      - name: Check if remote.txt is empty
        run: |
          if [ ! -s output/remote.txt ]; then
            echo "remote.txt is empty, creating placeholder"
            echo "# No channels found" > output/remote.txt
          fi

      - name: Merge remote.txt with userresult.txt
        run: |
          # 检查userresult.txt是否存在
          if [ ! -f output/userresult.txt ]; then
            echo "userresult.txt does not exist, skipping merge"
            exit 0
          fi
          
          # 创建临时文件
          temp_file=$(mktemp)
          
          # 读取remote.txt中的频道
          while IFS= read -r line; do
            if [ -n "$line" ] && [[ "$line" != "#"* ]]; then
              # 提取频道名称和URL
              channel_name=$(echo "$line" | cut -d',' -f1)
              channel_url=$(echo "$line" | cut -d',' -f2-)
              
              # 在userresult.txt中查找相同频道
              found_channel=false
              insert_position=0
              target_line=""
              
              # 读取userresult.txt查找匹配的频道
              line_number=0
              while IFS= read -r user_line; do
                line_number=$((line_number + 1))
                if [ -n "$user_line" ] && [[ "$user_line" != "#"* ]]; then
                  user_channel=$(echo "$user_line" | cut -d',' -f1)
                  if [ "$user_channel" = "$channel_name" ]; then
                    found_channel=true
                    insert_position=$line_number
                    target_line="$user_line"
                    break
                  fi
                fi
              done < output/userresult.txt
              
              if [ "$found_channel" = true ]; then
                # 检查目标频道的URL是否以指定域名开头
                if [[ "$target_line" == http://gslbmgsplive.miguvideo.com* ]]; then
                  # 替换该频道
                  echo "Replacing channel: $channel_name"
                  awk -v pos="$insert_position" -v new_line="$line" '
                  NR == pos { print new_line; next }
                  { print }
                  ' output/userresult.txt > "$temp_file"
                  mv "$temp_file" output/userresult.txt
                else
                  # 添加到该频道之前
                  echo "Inserting channel before: $channel_name"
                  awk -v pos="$insert_position" -v new_line="$line" '
                  NR == pos { print new_line }
                  { print }
                  ' output/userresult.txt > "$temp_file"
                  mv "$temp_file" output/userresult.txt
                fi
              fi
            fi
          done < output/remote.txt
          
          # 清理临时文件
          rm -f "$temp_file"

      - name: Commit and push if changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add output/remote.txt output/userresult.txt
          git diff --staged --quiet || git commit -m "Update channel lists with latest M3U data and merge results"
          git push
          
  sync-to-gitee:
    runs-on: ubuntu-latest
    needs: convert-m3u
    
    steps:
      - name: Checkout GitHub Repo
        uses: actions/checkout@v4
        with:
          ref: master
       
      - name: Download files
        run: |
          curl -o IPV4.txt "https://raw.githubusercontent.com/${{ github.repository }}/master/output/userresult.txt"
          curl -o IPV6.txt "https://raw.githubusercontent.com/${{ github.repository }}/master/output/ipv6/result.txt"
          curl -o IPV4.m3u "https://raw.githubusercontent.com/${{ github.repository }}/master/output/userresult.m3u"

      - name: Clone Gitee Repo
        env:
          GITEE_USER: ${{ secrets.GITEE_USER }}
          GITEE_TOKEN: ${{ secrets.GITEE_TOKEN }}
          GITEE_REPO: ${{ secrets.GITEE_REPO }}
        run: |
          git clone "https://${GITEE_USER}:${GITEE_TOKEN}@gitee.com/${GITEE_USER}/${GITEE_REPO}.git" gitee-repo

      - name: Sync files
        run: |
          cd gitee-repo
          git config user.name "GitHub Actions"
          git config user.email "actions@users.noreply.github.com"
          git checkout master || git checkout -b master
          cp ../IPV4.txt ./
          cp ../IPV6.txt ./
          cp ../IPV4.m3u ./
          git add IPV4.txt IPV6.txt IPV4.m3u
          git commit -m "Sync from GitHub" || exit 0
          git push origin master
