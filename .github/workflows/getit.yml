name: Convert and sycn

on:
  schedule:
    - cron: '2 */2 * * *'  # 每2小时执行一次
  workflow_dispatch:  # 支持手动触发

jobs:
  convert-m3u:
    runs-on: ubuntu-latest
    steps:
      - name: 检出代码
        uses: actions/checkout@v4

      - name: 创建输出目录
        run: mkdir -p output

      - name: 清除原有内容
        run: |
          > output/remote.txt

      - name: 下载并转换M3U文件
        run: |
          curl -s "https://raw.githubusercontent.com/develop202/migu_video/refs/heads/main/interface.txt" -o input.m3u
          
          awk -F',' '/^#EXTINF:/ { 
              gsub(/^#EXTINF:.*,/, ""); 
              channel_name = $0; 
              getline; 
              if ($0 !~ /^#/) {
                  gsub(/CCTV1综合/, "CCTV-1", channel_name);
                  gsub(/CCTV2财经/, "CCTV-2", channel_name);
                  gsub(/CCTV3综艺/, "CCTV-3", channel_name);
                  gsub(/CCTV4中文国际/, "CCTV-4", channel_name);
                  gsub(/CCTV5体育/, "CCTV-5", channel_name);
                  gsub(/CCTV5\+体育赛事/, "CCTV-5+", channel_name);
                  gsub(/CCTV6电影/, "CCTV-6", channel_name);
                  gsub(/CCTV7国防军事/, "CCTV-7", channel_name);
                  gsub(/CCTV8电视剧/, "CCTV-8", channel_name);
                  gsub(/CCTV9纪录/, "CCTV-9", channel_name);
                  gsub(/CCTV10科教/, "CCTV-10", channel_name);
                  gsub(/CCTV11戏曲/, "CCTV-11", channel_name);
                  gsub(/CCTV12社会与法/, "CCTV-12", channel_name);
                  gsub(/CCTV13新闻/, "CCTV-13", channel_name);
                  gsub(/CCTV14少儿/, "CCTV-14", channel_name);
                  gsub(/CCTV15音乐/, "CCTV-15", channel_name);
                  gsub(/CCTV16奥林匹克/, "CCTV-16", channel_name);
                  gsub(/CCTV17农业农村/, "CCTV-17", channel_name);
                  
                  print channel_name "," $0 >> "output/remote.txt"
              }
          }' input.m3u

      - name: 智能合并频道到userresult.txt
        run: |
          touch output/userresult.txt
          temp_file=$(mktemp)
          
          while IFS= read -r line; do
              if [ -n "$line" ]; then
                  channel_name=$(echo "$line" | cut -d',' -f1)
                  found_line=$(grep -n "^$channel_name," "output/userresult.txt" | head -1)
                  
                  if [ -n "$found_line" ]; then
                      line_num=$(echo "$found_line" | cut -d':' -f1)
                      original_line=$(echo "$found_line" | cut -d':' -f2-)
                      original_url=$(echo "$original_line" | cut -d',' -f2)
                      if [[ "$original_url" == http://gslbmgsplive.miguvideo.com* ]]; then
                          sed -i "${line_num}d" "output/userresult.txt"
                          echo "删除原频道 $channel_name (域名匹配)"
                      fi
                      
                      new_found_line=$(grep -n "^$channel_name," "output/userresult.txt" | head -1)
                      if [ -n "$new_found_line" ]; then
                          new_line_num=$(echo "$new_found_line" | cut -d':' -f1)
                          sed -i "${new_line_num}i\\$line" "output/userresult.txt"
                          echo "在行号 $new_line_num 前插入频道 $channel_name"
                      else
                          echo "$line" >> "output/userresult.txt"
                          echo "添加频道 $channel_name 到文件末尾"
                      fi
                  else
                      echo "频道 $channel_name 未在userresult.txt中找到，跳过添加"
                  fi
              fi
          done < "output/remote.txt"
          
          rm -f "$temp_file"

      - name: 提交转换结果
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add output/remote.txt output/userresult.txt
          git diff --staged --quiet || git commit -m "自动更新频道清单 [skip ci]"
          git push

  sync-to-gitee:
    runs-on: ubuntu-latest
    needs: convert-m3u
    steps:
      - name: Checkout GitHub Repo
        uses: actions/checkout@v4

      - name: Download File from GitHub
        run: |
          curl -o IPV4.txt https://raw.githubusercontent.com/jerome158/LIVETV/master/output/userresult.txt
          curl -o IPV6.txt https://raw.githubusercontent.com/jerome158/LIVETV/master/output/ipv6/result.txt
          curl -o IPV4.m3u https://raw.githubusercontent.com/jerome158/LIVETV/master/output/userresult.m3u

      - name: Clone Gitee Repo
        env:
          GITEE_USER: ${{ secrets.GITEE_USER }}
          GITEE_TOKEN: ${{ secrets.GITEE_TOKEN }}
          GITEE_REPO: ${{ secrets.GITEE_REPO }}
        run: |
          for i in {1..3}; do
            git clone "https://${GITEE_USER}:${GITEE_TOKEN}@gitee.com/${GITEE_USER}/${{ secrets.GITEE_REPO }}.git" && break || sleep 10
          done
          cd ${{ secrets.GITEE_REPO }}

      - name: Copy File & Push to Gitee
        env:
          GITEE_USER: ${{ secrets.GITEE_USER }}
          GITEE_REPO: ${{ secrets.GITEE_REPO }}
        run: |
          cd ${{ secrets.GITEE_REPO }}
          git config user.name "Auto Sync"
          git config user.email "auto-sync@users.noreply.github.com"
          cp ../IPV4.txt ./IPV4.txt
          cp ../IPV6.txt ./IPV6.txt
          cp ../IPV4.m3u ./IPV4.m3u
          git add IPV4.txt IPV6.txt IPV4.m3u
          if ! git diff --cached --quiet; then
            git commit -m "Sync file from GitHub $(date)"
            git push -f origin master
          else
            echo "No changes to commit"
          fi
